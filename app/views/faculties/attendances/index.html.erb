<h1>教員向け 出席管理画面 (動作確認用)</h1>

<% if notice %>
  <p style="color: green;">✅ <%= notice %></p>
<% end %>
<% if alert %>
  <p style="color: red;">❌ <%= alert %></p>
<% end %>

<% # 検索フォーム %>
<%= form_with(url: faculties_attendances_path, method: :get, local: true) do |form| %>
  <fieldset>
    <legend>検索</legend>
    <%= form.label :lesson_name, "授業名" %>
    <%= form.text_field :lesson_name, value: params[:lesson_name] %>
    
    <%= form.label :date, "日付" %>
    <%= form.date_field :date, value: params[:date] %>
    
    <%= form.submit "検索" %>
  </fieldset>
<% end %>

<hr>

<h2>集計結果 (JSONデータ)</h2>

<% # JSONの集計部分を表示 %>
<p><strong>総件数:</strong> <%= @json_response[:details].count %></p>
<ul>
  <% @json_response[:counts].each do |status, count| %>
    <li><strong><%= status.upcase %>:</strong> <%= count %>件</li>
  <% end %>
</ul>

<hr>

<h2>詳細一覧</h2>
<table border="1" cellpadding="10" style="width: 100%;">
  <thead>
    <tr>
      <th>学生番号</th>
      <th>氏名</th>
      <th>授業/時刻</th>
      <th>登録時刻</th>
      <th>ステータス</th>
      <th>理由</th>
      <th>承認状況</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody>
    <% @json_response[:details].each do |att| %>
      <tr>
        <td><%= att[:student_number] %></td>
        <td><%= att[:name] %></td>
        <td><%= att[:lesson_name] %></td>
        <td><%= att[:registered_at] %></td>
        <td>
          <strong style="color: <%= att[:status] == 'late' ? 'orange' : (att[:status] == 'absent' ? 'red' : 'green') %>;">
            <%= att[:status].upcase %>
          </strong>
        </td>
        <td><%= att[:late_reason] %></td>
        <td><%= att[:admin_approval] ? '✅ 承認済' : '❌ 未承認' %></td>
        <td>
          <% if att[:status] == 'late' && !att[:admin_approval] %>
            <% # 遅刻承認ボタン %>
            <%= form_with(url: faculties_attendance_path(att[:id]), method: :patch, local: true) do |form| %>
              <%= form.hidden_field :admin_approval, value: true %>
              <%= form.submit "遅刻承認", style: "background: yellowgreen; border: none;" %>
            <% end %>
          <% end %>

          <% # 欠席に変更ボタン %>
          <%= form_with(url: faculties_attendance_path(att[:id]), method: :patch, local: true) do |form| %>
            <%= form.hidden_field :status, value: 'absent' %>
            <%= form.submit "欠席にする", style: "background: salmon; border: none; margin-top: 5px;" %>
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>